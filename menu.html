<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–Ω—é</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h2>üçï –ù–∞—à–µ –º–µ–Ω—é</h2>
    <div id="menu"></div>

    <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div id="cart"></div>
    
    <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É..."></textarea>
    <button onclick="sendOrder()">üì© –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>

    <script>
        let cart = [];
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2MH7NNXTnwOqG8pOR0LNn6ENeI9QeTnf5IM-GkYuq-w3drVuhxfLb6nX-uQcNn6mBFcqLHIVGPNjI/pub?output=csv";

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ Google Drive
        function convertDriveLink(link) {
            if (!link || link.trim() === "") return "https://via.placeholder.com/100"; // –ó–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç
            if (link.includes("drive.google.com/file/d/")) {
                let fileId = link.split("/d/")[1].split("/view")[0];
                return `https://drive.google.com/uc?export=view&id=${fileId}`;
            }
            return link.trim(); // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é –∏–∑ Google Sheets
        function loadMenu() {
            fetch(sheetUrl)
                .then(response => response.text())
                .then(data => {
                    const rows = data.split("\n").map(row => row.split(","));
                    let menuHTML = "";

                    rows.forEach((item, index) => {
                        if (index === 0) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏

                        let name = item[1] ? item[1].trim() : "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"; // –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (B)
                        let size = item[2] ? item[2].trim() : ""; // –†–∞–∑–º–µ—Ä (C)
                        let description = item[3] ? item[3].trim() : "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"; // –û–ø–∏—Å–∞–Ω–∏–µ (D)
                        let price = item[4] ? parseFloat(item[4].trim()) : 0; // –¶–µ–Ω–∞ (E)
                        let imageUrl = item[5] ? convertDriveLink(item[5].trim()) : "https://via.placeholder.com/100"; // –§–æ—Ç–æ (F)

                        menuHTML += `
                            <div class="menu-item">
                                <img src="${imageUrl}" alt="${name}" style="width:100px;">
                                <h3>${name} ${size} - ${isNaN(price) ? "–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" : price + "‚ÇΩ"}</h3>
                                <p>${description}</p>
                                <button onclick="addToCart('${name}', ${price})">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>`;
                    });

                    document.getElementById("menu").innerHTML = menuHTML;
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", error));
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
        function addToCart(name, price) {
            let item = cart.find(i => i.name === name);
            if (item) {
                item.quantity++;
            } else {
                cart.push({ name, price, quantity: 1 });
            }
            updateCart();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        function removeFromCart(name) {
            cart = cart.filter(item => item.name !== name);
            updateCart();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCart() {
            let cartHTML = "";
            let total = 0;

            cart.forEach((item) => {
                total += item.price * item.quantity;
                cartHTML += `
                    <div class="cart-item">
                        <span>${item.name} x${item.quantity} - ${item.price * item.quantity}‚ÇΩ</span>
                        <button onclick="removeFromCart('${item.name}')">‚ùå</button>
                    </div>`;
            });

            cartHTML += `<p><strong>üí∞ –ò—Ç–æ–≥–æ: ${total}‚ÇΩ</strong></p>`;
            document.getElementById("cart").innerHTML = cartHTML;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –≤ Telegram
        function sendOrder() {
            if (cart.length === 0) {
                alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
                return;
            }

            let orderText = cart.map(i => `${i.name} x${i.quantity} - ${i.price * i.quantity}‚ÇΩ`).join("\n");
            let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            let comment = document.getElementById("comment").value;

            let fullText = `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑:\n${orderText}\nüí∞ –û–±—â–∞—è —Å—É–º–º–∞: ${total}‚ÇΩ\n‚úèÔ∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}`;

            Telegram.WebApp.sendData(fullText);
            alert("‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            cart = [];
            updateCart();
            document.getElementById("comment").value = "";
        }

        loadMenu();
    </script>
</body>
</html>
